#!/usr/bin/env python3
import pycx4.pycda as cda
import numpy as np
from cservice import CXService

khi = np.array([
    [9.457586127393008e-19, -2.996013976377047e-14, 3.403071228816144e-10, -1.580203855597708e-06, 6.200608486053660e-02, -1.282214443463090e-01],
    [1.092972918832383e-18, -3.777526599940410e-14, 4.945536920388338e-10, -2.991836510765102e-06, 6.817090475019461e-02, -9.938822872552009e+00],
    [8.490285185041267e-19, -2.493796030514625e-14, 2.421406833460418e-10, -6.873038195282129e-07, 5.821007456367022e-02, 6.015887179324636e+00],
    [1.055668754405803e-18, -3.569886675461367e-14, 4.509171423195795e-10, -2.569268125311242e-06, 6.624607815563266e-02, -6.584364846198696e+00],
    [9.724121109898388e-19, -3.136024084375173e-14, 3.671831675385920e-10, -1.817828102485658e-06, 6.301040646423139e-02, -1.505496468424099e+00],
    [1.059323059986846e-18, -3.594318176939103e-14, 4.554934175336299e-10, -2.592698108843348e-06, 6.611888118907761e-02, -6.537159830725614e+00],
    [1.049219739796873e-18, -3.526444355925847e-14, 4.415244810679605e-10, -2.479232131126930e-06, 6.592154232053993e-02, -6.117601255311456e+00],
    [9.633537353215862e-19, -3.083860216191559e-14, 3.561202411975073e-10, -1.715338341705679e-06, 6.256294873201806e-02, -8.294665809535218e-01],
])

kih = np.array([
    [1.796276845339243e-11, -6.464923647099571e-08, 8.131949428484683e-05, -4.657317643590364e-02, 2.901198255789006e+01, -1.174062279570280e+03],
    [1.486541198055152e-11, -5.499394169238151e-08, 7.015159673723261e-05, -4.058484172235532e-02, 2.747470801215763e+01, -1.030588635014865e+03],
    [1.947644629291918e-11, -6.942984686742503e-08, 8.695244470595994e-05, -4.963485929740274e-02, 2.978633743883768e+01, -1.248903807980358e+03],
    [1.590127764755069e-11, -5.844645414529061e-08, 7.445044243156815e-05, -4.305275870921443e-02, 2.813995364723326e+01, -1.098902517806069e+03],
    [1.741870241239122e-11, -6.303768612302368e-08, 7.957827656105863e-05, -4.571017936892963e-02, 2.880644566338901e+01, -1.159275993407238e+03],
    [1.591837695634934e-11, -5.849480295674144e-08, 7.453640754008419e-05, -4.317670904332793e-02, 2.823013931188973e+01, -1.104232862194505e+03],
    [1.593609546132517e-11, -5.851156091671195e-08, 7.448151351990189e-05, -4.305008018453149e-02, 2.811597141953257e+01, -1.095340998297819e+03],
    [1.777904217064836e-11, -6.422832673483560e-08, 8.101115341534832e-05, -4.647970985971339e-02, 2.900035403133325e+01, -1.176663411081245e+03]
])


class EnergyCalc(object):
    def __init__(self):
        # registering chans
        self.c_drm_set = cda.DChan("canhw:12.dRM.Iset")
        self.c_crm_set = [cda.DChan("canhw:12.rst2.cRM" + str(x+1) + ".Iset") for x in range(8)]
        self.c_eset = cda.DChan("cxhw:0.info.Emag")
        self.c_drm_set.valueChanged.connect(self.update_energy)
        for x in self.c_crm_set:
            x.valueChanged.connect(self.update_energy)
        self.H = np.zeros(8)
        self.Hmean = 0
        self.Eset = 0

    def update_energy(self, chan):
        for x in range(8):
            self.H[x] = np.polyval(kih[x], self.c_drm_set.val + self.c_crm_set[x].val * 80.0 / (24.0 * 1000))
        self.Hmean = np.mean(self.H)
        self.Eset = self.Hmean * 300 * 112.0 / 1.0e6
        self.c_eset.setValue(self.Eset)


class EnergyCalcService(CXService):
    def main(self):
        self.Ecalc = EnergyCalc()



# this runs service
ser = EnergyCalcService('energy_calc')


